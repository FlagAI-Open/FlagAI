
![Aquila_logo](../img/Aquila.PNG)



# æ‚Ÿé“Â·å¤©é¹°ï¼ˆAquilaï¼‰

æ‚Ÿé“Â·å¤©é¹°ï¼ˆAquilaï¼‰ è¯­è¨€å¤§æ¨¡å‹æ˜¯é¦–ä¸ªå…·å¤‡ä¸­è‹±åŒè¯­çŸ¥è¯†ã€æ”¯æŒå•†ç”¨è®¸å¯åè®®ã€å›½å†…æ•°æ®åˆè§„éœ€æ±‚çš„å¼€æºè¯­è¨€å¤§æ¨¡å‹ã€‚
- ğŸŒŸ **æ”¯æŒå¼€æºå•†ç”¨è®¸å¯**ã€‚Aquilaç³»åˆ—æ¨¡å‹çš„æºä»£ç åŸºäº [Apache 2.0 åè®®](https://www.apache.org/licenses/LICENSE-2.0)ï¼Œæ¨¡å‹æƒé‡åŸºäº[ã€Šæ™ºæºAquilaç³»åˆ—æ¨¡å‹è®¸å¯åè®®ã€‹](../../BAAI_Aquila_Model_License.pdf)ï¼Œä½¿ç”¨è€…åœ¨æ»¡è¶³è®¸å¯é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œå¯ç”¨äºå•†ä¸šç›®çš„ã€‚
- âœï¸ **å…·å¤‡ä¸­è‹±æ–‡çŸ¥è¯†**ã€‚Aquilaç³»åˆ—æ¨¡å‹åœ¨ä¸­è‹±æ–‡é«˜è´¨é‡è¯­æ–™åŸºç¡€ä¸Šä» 0 å¼€å§‹è®­ç»ƒï¼Œä¸­æ–‡è¯­æ–™çº¦å  40%ï¼Œä¿è¯æ¨¡å‹åœ¨é¢„è®­ç»ƒé˜¶æ®µå°±å¼€å§‹ç§¯ç´¯åŸç”Ÿçš„ä¸­æ–‡ä¸–ç•ŒçŸ¥è¯†ï¼Œè€Œéç¿»è¯‘è€Œæ¥çš„çŸ¥è¯†ã€‚
- ğŸ‘®â€â™€ï¸**ç¬¦åˆå›½å†…æ•°æ®åˆè§„éœ€æ±‚**ã€‚Aquilaç³»åˆ—æ¨¡å‹çš„ä¸­æ–‡è¯­æ–™æ¥è‡ªæ™ºæºå¤šå¹´ç§¯ç´¯çš„ä¸­æ–‡æ•°æ®é›†ï¼ŒåŒ…æ‹¬æ¥è‡ª1ä¸‡å¤šä¸ªç«™æºçš„ä¸­æ–‡äº’è”ç½‘æ•°æ®ï¼ˆå…¶ä¸­99%ä»¥ä¸Šä¸ºå›½å†…ç«™æºï¼‰ï¼Œä»¥åŠè·å¾—å›½å†…æƒå¨æœºæ„æ”¯æŒçš„é«˜è´¨é‡ä¸­æ–‡æ–‡çŒ®æ•°æ®ã€ä¸­æ–‡ä¹¦ç±æ•°æ®ç­‰ã€‚æˆ‘ä»¬ä»åœ¨æŒç»­ç§¯ç´¯é«˜è´¨é‡ã€å¤šæ ·åŒ–çš„æ•°æ®é›†ï¼Œå¹¶æºæºä¸æ–­åŠ å…¥AquilaåŸºç¡€æ¨¡å‹åç»­è®­ç»ƒä¸­ã€‚
- ğŸ¯**æŒç»­è¿­ä»£**ï¼ŒæŒç»­å¼€æºå¼€æ”¾ã€‚æˆ‘ä»¬å°†ä¸æ–­å®Œå–„è®­ç»ƒæ•°æ®ã€ä¼˜åŒ–è®­ç»ƒæ–¹æ³•ã€æå‡æ¨¡å‹æ€§èƒ½ï¼Œåœ¨æ›´ä¼˜ç§€çš„åŸºç¡€æ¨¡å‹åŸºåº§ä¸Šï¼ŒåŸ¹è‚²æç¹å¶èŒ‚çš„â€œæ¨¡å‹æ ‘â€ï¼ŒæŒç»­å¼€æºå¼€æ”¾æ›´æ–°çš„ç‰ˆæœ¬ã€‚


æ‚Ÿé“ Â· å¤©é¹° Aquila æ¨¡å‹çš„æ›´å¤šç»†èŠ‚å°†åœ¨å®˜æ–¹æŠ€æœ¯æŠ¥å‘Šä¸­å‘ˆç°ã€‚è¯·å…³æ³¨å®˜æ–¹æ¸ é“æ›´æ–°ã€‚åŒ…æ‹¬ [FlagAI GitHubä»“åº“](https://github.com/FlagAI-Open/FlagAI/)ï¼Œ[FlagAI çŸ¥ä¹è´¦å·](https://www.zhihu.com/people/95-22-20-18)ã€[FlagAI å®˜æ–¹æŠ€æœ¯äº¤æµç¾¤](https://github.com/FlagAI-Open/FlagAI/blob/master/wechat-qrcode.jpg)ã€æ™ºæºç ”ç©¶é™¢å¾®ä¿¡å…¬ä¼—å·ã€æ™ºæºç¤¾åŒºå¾®ä¿¡å…¬ä¼—å·ã€‚


|   æ¨¡å‹          |  æ¨¡å‹ç±»å‹    | ç®€ä»‹  |  æ–‡ä»¶è·¯å¾„   |   å•ç‹¬ä¸‹è½½æ¨¡å‹æƒé‡  |  çŠ¶æ€   |  è®­ç»ƒæ‰€ç”¨æ˜¾å¡   |
| :---------------- | :------- | :-- |:-- |   :-- | :-- | :-- |
| Aquila-7B         | åŸºç¡€æ¨¡å‹ï¼Œ70äº¿å‚æ•°  |   **Aquila åŸºç¡€æ¨¡å‹**åœ¨æŠ€æœ¯ä¸Šç»§æ‰¿äº† GPT-3ã€LLaMA ç­‰çš„æ¶æ„è®¾è®¡ä¼˜ç‚¹ï¼Œæ›¿æ¢äº†ä¸€æ‰¹æ›´é«˜æ•ˆçš„åº•å±‚ç®—å­å®ç°ã€é‡æ–°è®¾è®¡å®ç°äº†ä¸­è‹±åŒè¯­çš„ tokenizerï¼Œå‡çº§äº† BMTrain å¹¶è¡Œè®­ç»ƒæ–¹æ³•ï¼Œå®ç°äº†æ¯” Magtron+DeepSpeed ZeRO-2 å°†è¿‘ï¼˜å€çš„è®­ç»ƒæ•ˆç‡ã€‚   | [./examples/Aquila/Aquila-pretrain](https://github.com/FlagAI-Open/FlagAI/tree/master/examples/Aquila/Aquila-pretrain)  | [ä¸‹è½½Aquila-7B](http://model.baai.ac.cn/model-detail/100098)<br> [HFä»“åº“åœ°å€](https://huggingface.co/BAAI/Aquila-7B) | å·²å‘å¸ƒ | Nvidia-A100 |
| Aquila-33B          |åŸºç¡€æ¨¡å‹ï¼Œ330äº¿å‚æ•°  |    åŒä¸Š    | â€”â€”  | â€”â€”  | **æ•¬è¯·æœŸå¾…** | Nvidia-A100 |
| AquilaChat-7B          |SFT æ¨¡å‹ï¼ŒåŸºäº Aquila-7B è¿›è¡Œå¾®è°ƒå’Œå¼ºåŒ–å­¦ä¹   |    **AquilaChat å¯¹è¯æ¨¡å‹**æ”¯æŒæµç•…çš„æ–‡æœ¬å¯¹è¯åŠå¤šç§è¯­è¨€ç±»ç”Ÿæˆä»»åŠ¡ï¼Œé€šè¿‡å®šä¹‰å¯æ‰©å±•çš„ç‰¹æ®ŠæŒ‡ä»¤è§„èŒƒï¼Œå®ç° AquilaChatå¯¹å…¶å®ƒæ¨¡å‹å’Œå·¥å…·çš„è°ƒç”¨ï¼Œä¸”æ˜“äºæ‰©å±•ã€‚ <br><br>ä¾‹å¦‚ï¼Œè°ƒç”¨æ™ºæºå¼€æºçš„ **[AltDiffusion](https://github.com/FlagAI-Open/FlagAI/tree/master/examples/AltDiffusion-m18) å¤šè¯­è¨€æ–‡å›¾ç”Ÿæˆæ¨¡å‹**ï¼Œå®ç°äº†æµç•…çš„æ–‡å›¾ç”Ÿæˆèƒ½åŠ›ã€‚é…åˆæ™ºæº **InstructFace å¤šæ­¥å¯æ§æ–‡ç”Ÿå›¾æ¨¡å‹**ï¼Œè½»æ¾å®ç°å¯¹äººè„¸å›¾åƒçš„å¤šæ­¥å¯æ§ç¼–è¾‘ã€‚  |   [./examples/Aquila/Aquila-chat](https://github.com/FlagAI-Open/FlagAI/tree/master/examples/Aquila/Aquila-chat)  | [ä¸‹è½½AquilaChat-7B](https://model.baai.ac.cn/model-detail/100101) <br> [HFä»“åº“åœ°å€](https://huggingface.co/BAAI/AquilaChat-7B)| å·²å‘å¸ƒ  | Nvidia-A100  |
| AquilaChat-33B           |SFT æ¨¡å‹ï¼ŒåŸºäº Aquila-33B è¿›è¡Œå¾®è°ƒå’Œå¼ºåŒ–å­¦ä¹  |   åŒä¸Š    |   â€”â€”    |â€”â€”  | **æ•¬è¯·æœŸå¾…** | Nvidia-A100 |
| AquilaCode-multi         | åŸºç¡€æ¨¡å‹ï¼Œâ€œæ–‡æœ¬-ä»£ç â€ç”Ÿæˆæ¨¡å‹ï¼ŒåŸºäº Aquila-7Bç»§ç»­é¢„è®­ç»ƒ  |   AquilaCode ä½¿ç”¨ç»è¿‡é«˜è´¨é‡è¿‡æ»¤ä¸”æœ‰åˆè§„å¼€æºè®¸å¯çš„ä»£ç æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œæ•°æ®é‡çº¦ä¸ºå…¶ä»–å¼€æºä»£ç ç”Ÿæˆæ¨¡å‹çš„ 10ï½40%ã€‚é€šè¿‡å‚è€ƒå®˜æ–¹æä¾›çš„æ“ä½œæŒ‡å—ï¼Œå¼€å‘è€…å¯ä»¥åˆ©ç”¨ AquilaCode æ¨¡å‹æ¥å®šåˆ¶è‡ªå·±çš„ä»£ç åŠ©æ‰‹ã€‚  | [./examples/Aquila/Aquila-code](https://github.com/FlagAI-Open/FlagAI/tree/master/examples/Aquila/Aquila-code)  |[ä¸‹è½½AquilaCode-7B-multi](https://model.baai.ac.cn/model-detail/100104) <br> [HFä»“åº“åœ°å€](https://huggingface.co/BAAI/AquilaCode-multi) | å·²å‘å¸ƒ  | Nvidia-A100 |
| AquilaCode-py           |åŸºç¡€æ¨¡å‹ï¼Œâ€œæ–‡æœ¬-ä»£ç â€ç”Ÿæˆæ¨¡å‹ï¼ŒåŸºäº Aquila-7Bç»§ç»­é¢„è®­ç»ƒã€‚  |    AquilaCode ä½¿ç”¨ç»è¿‡é«˜è´¨é‡è¿‡æ»¤ä¸”æœ‰åˆè§„å¼€æºè®¸å¯çš„ä»£ç æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œæ•°æ®é‡çº¦ä¸ºå…¶ä»–å¼€æºä»£ç ç”Ÿæˆæ¨¡å‹çš„ 10ï½40%ã€‚é€šè¿‡å‚è€ƒå®˜æ–¹æä¾›çš„æ“ä½œæŒ‡å—ï¼Œå¼€å‘è€…å¯ä»¥åˆ©ç”¨ AquilaCode æ¨¡å‹å®šåˆ¶è‡ªå·±çš„ä»£ç åŠ©æ‰‹ã€‚    | [./examples/Aquila/Aquila-code](https://github.com/FlagAI-Open/FlagAI/tree/master/examples/Aquila/Aquila-code)  | [ä¸‹è½½AquilaCode-py](https://model.baai.ac.cn/model-detail/100103) <br> [HFä»“åº“åœ°å€](https://huggingface.co/BAAI/AquilaCode-py) | å·²å‘å¸ƒ  | Nvidia-A100  |
| AquilaSQL-7B           |å¯¹è¯æ¨¡å‹ï¼Œâ€œæ–‡æœ¬-ä»£ç â€ç”Ÿæˆæ¨¡å‹ï¼ŒåŸºäº AquilaCodeç»§ç»­é¢„è®­ç»ƒ+SFTã€‚  |   AquilaSQLåœ¨ä»£ç åŸºç¡€æ¨¡å‹AquilaCodeä¸Šè¿›è¡Œç»§ç»­é¢„è®­ç»ƒå’Œsftå¾®è°ƒï¼Œä¸ºæ¨¡å‹è®¾è®¡äº†æŒ‡æ ‡è¯„ä¼°ä½“ç³»ï¼Œç›®å‰åœ¨cspideræ¦œå•ä¸Šè¾¾åˆ°äº†sotaï¼Œå¯ä»¥é€šè¿‡æ›´æ”¹æ•°æ®çš„æ–¹å¼é€‚é…ä¸åŒé¢†åŸŸçš„sqlæŸ¥è¯¢åœºæ™¯ã€‚    | [./examples/Aquila/Aquila-sql](https://github.com/FlagAI-Open/FlagAI/tree/master/examples/Aquila/Aquila-sql)  | [ä¸‹è½½AquilaSQL-7B](https://model.baai.ac.cn/model-detail/100115) <br> [HFä»“åº“åœ°å€](https://huggingface.co/BAAI/AquilaSQL-7B) | å·²å‘å¸ƒ  | Nvidia-A100  |

æ‚Ÿé“Â·å¤©é¹°Aquilaç³»åˆ—æ¨¡å‹å°†æŒç»­å¼€æºæ›´ä¼˜ç‰ˆæœ¬ï¼Œå¤§å®¶å¯ä»¥å…ˆåˆ é™¤åŸæ¥ç›®å½•ä¸‹çš„codeæ¨¡å‹è·¯å¾„ï¼Œå†ä¸‹è½½æ–°æƒé‡ï¼Œå…¶ä»–ä½¿ç”¨æ–¹å¼ä¸å˜ã€‚


## è®­ç»ƒè¯„ä¼°æµç¨‹

1. é¢„è®­ç»ƒæµç¨‹ä¸codeæ¨¡å‹é¢„è®­ç»ƒå®Œå…¨ä¸€è‡´ï¼Œè¿™é‡Œä¸åœ¨èµ˜è¿°
 - æ”¶é›†æ•°æ®ï¼šç½‘ç»œçˆ¬å–sqlæ•°æ®ï¼Œhuggingfaceæ•°æ®é›†æ”¶é›†ï¼Œå¼€æºæ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥è‡ªè¡Œæ”¶é›†
    ```python
    opensource_data_map = {
    "autotrain-data-nl-to-sql": ["https://huggingface.co/datasets/Aditya011/autotrain-data-nl-to-sql", "./sql-data-raw/autotrain-data-nl-to-sql-train.csv"],
    "pg-wikiSQL-sql-instructions-80k": ["https://huggingface.co/datasets/kaxap/pg-wikiSQL-sql-instructions-80k/tree/main", "./sql-data-raw/pg-wikiSQL-sql-instructions-80k-train.csv"],
    "pg-wikiSQL-sql-instructions-80k-val": ["https://huggingface.co/datasets/kaxap/pg-wikiSQL-sql-instructions-80k/tree/main", "./sql-data-raw/pg-wikiSQL-sql-instructions-80k-dev.csv"],
    "pg-gpt4SQL-sql-instructions-1k": ["https://huggingface.co/datasets/kaxap/pg-gpt4SQL-sql-instructions-1k", "./sql-data-raw/pg-gpt4SQL-sql-instructions-1k.csv"],
    "Text-to-sql-v1": ["https://huggingface.co/datasets/Clinton/Text-to-sql-v1", "./sql-data-raw/Text-to-sql-v1.jsonl"],
    "sql-create-context": ["https://huggingface.co/datasets/b-mc2/sql-create-context/tree/main", "./sql-data-raw/sql_create_context_v4.json"],
    "Llama-2-SQL-Dataset": ["https://huggingface.co/datasets/ChrisHayduk/Llama-2-SQL-Dataset", "./sql-data-raw/Llama-2-SQL-Dataset-train-00000-of-00001-1ba781ea67c6bd7f.parquet"],
    "sql-context-instructions": ["https://huggingface.co/datasets/goendalf666/sql-context-instructions/tree/main", "./sql-data-raw/sql-context-instructions-train-00000-of-00001-a2d2f513b79f5b3d.parquet"],
    "symbolic-instruction-tuning-sql": ["https://huggingface.co/datasets/tasksource/symbolic-instruction-tuning-sql", "./sql-data-raw/symbolic-instruction-tuning-sql-train-00000-of-00001-09775d42d91b2c08.parquet"]
    }
    ```
    - æ•°æ®å¤„ç†ï¼šå°†æ•°æ®å¤„ç†æˆAquilaæ¨¡å‹é¢„è®­ç»ƒæ ¼å¼ï¼Œå¹¶åˆ¶ä½œæˆäºŒè¿›åˆ¶æ–‡ä»¶
    - æ•°æ®è§„æ¨¡ï¼š2M
    - ç¡¬ä»¶é…ç½®ï¼š4æœºï¼Œ8å¡ï¼ŒA100-40G
    - è®­ç»ƒé…ç½®ï¼š[Aquila-pretrain-4n8g.yaml](./Aquila-pretrain-4n8g.yaml)
    - è®­ç»ƒé˜¶æ®µæ›²çº¿
    ![aquila-sql-pretrain-loss](../img/aquila-sql-pretrain-loss.png)

2. SFTè®­ç»ƒ

    ä¸ºäº†è¿›è¡ŒæŒ‡æ ‡è®¡ç®—ï¼Œå°†sftæ•°æ®ä¸­answeréƒ¨åˆ†æŒ‰ç…§å›ºå®šæ ¼å¼è¿›è¡Œåˆ¶ä½œï¼Œä¾¿äºåç»­è§£æï¼Œç¤ºä¾‹å¦‚ä¸‹
    ![aquila-sql-data](../img/aquila-sql-data.png)
    - æ•°æ®æ¥æºï¼šwikisqlï¼Œspider,cspiderå¼€æºæ•°æ®é›†è®­ç»ƒé›†è¿›è¡Œé…æ¯”å®Œæˆ
    - æ•°æ®ä½ç½®ä¸ºï¼š[sft-data](./data/sql_generate_from_spider_wikisql_train_weighted.jsonl)
    - è®­ç»ƒé…ç½®ä¸ºï¼š[Aquila-sft-sql.yaml](./Aquila-sft-sql.yaml)

3. sqlæŒ‡æ ‡è®¡ç®—
    ç”¨äºè¯„ä¼°ä»£ç æ¨¡å‹çš„humanevalä¸æ”¯æŒsqlè¯­è¨€ï¼Œè¿™é‡Œä½¿ç”¨text2sqlé¢†åŸŸå¸¸ç”¨çš„è¯„ä¼°æ–¹å¼ï¼Œè¯„ä¼°ç”Ÿäº§çš„sqlè¯­å¥ä¸æ ‡ç­¾çš„åŒ¹é…åº¦å’Œç¼–è¯‘é€šè¿‡ç‡ä¸¤ä¸ªæŒ‡æ ‡
    - æ¨¡å‹ç»“æ„è½¬æ¢ï¼šå°†è®­ç»ƒå¥½çš„æ¨¡å‹è½¬æ¢æˆflagaiæ¨¡å‹ç»“æ„ï¼Œ[s1_convert_flash2flagai.py](./metric/s1_convert_flash2flagai.py)ï¼Œå¯åœ¨[è¿™é‡Œ]()ä¸‹è½½
    - æ¨¡å‹æ¨ç†ï¼š[s2_model_infer_gen_sql.py](./metric/s2_model_infer_gen_sql.py) ä½¿ç”¨è¯­è¨€æ¨¡å‹ç”ŸæˆæŸ¥è¯¢è¯­å¥çš„sqlè¯­å¥ï¼Œå¹¶å°†è¾“å‡ºç»“æœä¿å­˜åˆ°[evaluation_result](./evaluation_result)ä¸­ï¼›
    - æŒ‡æ ‡è®¡ç®—ï¼š[s3_calculate_sql_acc.py](./metric/s3_calculate_sql_acc.py) è®¡ç®—ç”Ÿæˆçš„sqlè¯­å¥çš„æŒ‡æ ‡
    - æ’è¡Œæ¦œï¼šhttps://taolusi.github.io/CSpider-explorer/
    ![leadboard-cspider](../img/cspider-leadboard.png)
    - aquila-sqlæŒ‡æ ‡è¡¨ç°
    ![aquila-sql-acc-cspider](../img/aquila-sql-acc.png)

## å¿«é€Ÿå¼€å§‹ä½¿ç”¨ AquilaCode-7B åŸºç¡€æ¨¡å‹

### åŸºç¡€æ¨¡å‹çš„ç¯å¢ƒå‡†å¤‡

1. åœ¨æœ¬åœ°å…‹éš†FlagAI githubä»“åº“

    ```
    git clone https://github.com/FlagAI-Open/FlagAI.git
    ```

2. è¿›å…¥ä»“åº“ï¼Œä»æºç å®‰è£…FlagAI

    ```
    cd FlagAI
    python setup.py install
    ```
    æ³¨ï¼šæˆ‘ä»¬ç›®å‰æ”¯æŒåœ¨Ubuntu, Macå’ŒMacä¸Šè¿è¡Œï¼Œè¯¦ç»†ç¯å¢ƒä¾èµ–ä¿¡æ¯å¯å‚è€ƒ [FlagAIç¯å¢ƒå®‰è£…](../../../README_zh.md#quick-start)

3. è¿›å…¥**AquilaCode-7BåŸºç¡€æ¨¡å‹**ç›®å½•
    ```
    cd examples/Aquila/Aquila-sql
    ```

### æ¨¡å‹æ¨ç†
- æ¨¡å‹ä¸‹è½½
    - ç›´æ¥modelhubä¸‹è½½

    - autoloaderçš„å½¢å¼ä¸‹è½½
    ```
    start_time = time.time()
    loader = AutoLoader(
        "lm",
        model_dir=state_dict,
        model_name=model_name,
        use_cache=True,
        fp16=True,
        device=device)
    ```

- æœ¬åœ°æ¨ç†æµ‹è¯•

```
CUDA_VISIBLE_DEVICES=0 python3 server_local.py  ckpt_dir
```
è¿è¡Œä¹‹åæ¨¡å‹æœ‰å¦‚ä¸‹ç”Ÿæˆ
![aquila-sql-gen-result](../img/aquila-sql-gen-result.png)


- åˆ›å»ºserverç”¨äºrequestè®¿é—®

```
CUDA_VISIBLE_DEVICES=1 python3 server_web.py ckpt_dir
```

è¿è¡Œä¹‹åï¼Œç»ˆç«¯æœ‰å¦‚ä¸‹è¾“å‡ºï¼Œè¡¨ç¤ºæœåŠ¡å¯åŠ¨æˆåŠŸï¼Œå¯ä»¥ä½¿ç”¨requestçš„æ–¹å¼è°ƒç”¨

![aquila-sql-server-web](../img/aquila-sql-server-web.png)

- ä½¿ç”¨huggingfaceçš„æ¨¡å‹è¿›è¡Œæ¨ç†
hfæ¨¡å‹ä½ç½®

```
CUDA_VISIBLE_DEVICES=1 python3 server_hf.py ckpt_dir
```

## è¯ä¹¦

AquilaSQL-7B [æ™ºæºAquilaç³»åˆ—æ¨¡å‹è®¸å¯åè®®](../../../BAAI_Aquila_Model_License.pdf), åŸå§‹ä»£ç åŸºäº[Apache Licence 2.0](https://www.apache.org/licenses/LICENSE-2.0)ã€‚

